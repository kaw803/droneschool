17th Hiroaki-Kawasaki

# コース２ python scriptの練習
エンジニア養成塾 コース２の宿題
## 014_takeoff.py
（変更点）
- 動作開始からの時間とRTLの追加

## 015_takeoff_util.py
（変更点）
- RTLの追加

# コース３ チーム課題
エンジニア養成塾 コース３ チーム１

## Pre-Arm Motor Check
Disarm状態のときに、
特定のモード（SCR_USER1が0のときはAcro、0以外のときはその値に対応するモード）に変更されたとき、
右回りに１つずつモーターを特定の出力（MOT_SPIN_ARMで設定された値）で回転させて、
その出力に対して、実際にモーターが期待されている回転数（SCR_USER2が0のときは1500、0以外のときはその値で示される回転数）に対して、
特定の範囲（SCR_USER3が0のときは上下20%以内、0以外のときはその値で示されるパーセンテージ以内）で動作しているかをチェックし、
４つのモーターがすべて範囲内ならアームする。

| Param | Discription | Default |
|---|---|---|
| SCR_USER1 | 指定されたモードに変更されたら、この機能が実行される | Acro |
| SCR_USER2 | MOT_SPIN_ARM で指定される出力で動作した際に期待されるモーターの回転数 (rpm) | 1500 |
| SCR_USER3 | 回転数のばらつき誤差の許容範囲（±パーセント） | ±20% |

### コンパニオンコンピューター
今回はM5AtomS3と反射型光学センサーの組み合わせにより、４つのモーターの回転数を直接カウントし、ディスプレイ上に表示し、そのデータをシリアル通信でフライトコントローラーに送信している。

今回の実装では、Pixhawk 6CのTelem3(Serial5に相当)と接続した。

実行には `SERIAL5_PROTOCOL`を `28(Scriipting)` に設定する必要がある。

![S__9871363](https://github.com/tajisoft/droneschool/assets/85010654/91ef5019-3dc3-4e68-aadb-3633f854a906)

### コンパニオンコンピューター側のソースコード
CC側のソースコードはplatformIO環境で実装している。
参考のため、`M5atomS3_source`フォルダにコードを置いた。
https://github.com/kaw803/droneschool/tree/feat/add_M5atomS3_source/workshop/17th/hiroaki-kawasaki


### Serial data format
コンパニオンコンピューター（ESP32S3）から、シリアル通信で、１秒間隔で各モーターの回転数が送信されている。
そのデータをLuaスクリプトで受信する。
データ列は10バイト一組で、データ区切りとしてのヘッダーと、４つのモーターの回転数、チェックサムを含む。


| バイト | 内容 |
|---|---|
| 0   | 0xff const|
| 1-2 | motor1 rpm (16bit) |
| 3-4 | motor2 rpm (16bit) |
| 5-6 | motot3 rpm (16bit) |
| 7-8 | motot4 rpm (16bit) |
| 9   | check sum(1 to 8)|

### 今後の課題
現時点ではSerial通信のカスタムデータとしているが、
MAVLinkの「ESC_STATUS (291) (WIP)」や「RAW_RPM(339)」などの利用が好ましいと考える。
また、Serialではなく、I2C、CANなども可能。

最終的には、FCでのIMUの振動解析によって回転数の推定ができれば、今回のような付加デバイスが必要なくなるが、
実際の回転数とFFT解析による回転数との相関を調査したり、ノッチフィルタの検証などを行う必要があるので、
それらを行うためにも直接的に回転数を知る方法として、本方式をベースにすることができる。

##  Altitude-Based Speed Limit (wip)
高度に応じた水平方向の最高速度制限(Luaスクリプト)

【目的】
飛行訓練用として、高度が低い場合、最高速度が低速で、安全な高度まで上昇したら最高速度が高速になる

